<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Papeletas - Cirineo v3.4</title>
    
    <link rel="icon" href="https://raw.githubusercontent.com/jesusvn1993mplvt3-ai/CIRINEO/refs/heads/main/icon.ico">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.0/dist/JsBarcode.all.min.js"></script>
    
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;700&family=Roboto+Condensed:wght@400;700&display=swap" rel="stylesheet">

    <style>
        body { background-color: #f1f5f9; min-height: 100vh; font-family: 'Roboto Condensed', sans-serif; overflow: hidden; }
        @media (max-width: 1024px) { body { height: auto; overflow-y: auto; overflow-x: hidden; } }
        #reader a, #reader-hidden a { display: none !important; }
        
        /* ESTILO ORIGINAL DEL CONTENEDOR DE LA ETIQUETA EN PANTALLA */
        .label-wrapper { margin-bottom: 2rem; padding: 1rem; background: white; border-radius: 0.5rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); page-break-inside: avoid; }
        
        /* ESTILO TEMPORAL PARA PDF: ELIMINA MARGEN Y SOMBRA EN PANTALLA PARA GENERAR EL PDF CORRECTO */
        .pdf-mode .label-wrapper {
            margin-bottom: 0 !important;
            padding: 0 !important;
            box-shadow: none !important;
            break-after: page; 
            page-break-after: always;
        }

        .label-preview-container { width: 6in; height: 4in; background-color: white; position: relative; box-sizing: border-box; border: 2px solid #000; display: flex; flex-direction: column; overflow: hidden; }
        .lbl-row { display: flex; border-bottom: 2px solid #000; width: 100%; }
        .lbl-row:last-child { border-bottom: none; }
        .lbl-col { border-right: 2px solid #000; padding: 4px 8px; display: flex; flex-direction: column; justify-content: center; overflow: hidden; }
        .lbl-col:last-child { border-right: none; }
        .lbl-title { font-size: 14px; font-weight: 700; color: #333; text-transform: uppercase; line-height: 1; margin-bottom: 2px; }
        .lbl-big { font-family: 'Oswald', sans-serif; font-weight: 700; font-size: 42px; line-height: 0.9; color: #000; white-space: nowrap; }
        .lbl-medium { font-family: 'Oswald', sans-serif; font-weight: 700; font-size: 26px; line-height: 1; color: #000; white-space: nowrap; }
        .lbl-small { font-size: 16px; font-weight: 700; color: #000; }
        .row-header { height: 18%; } .row-info { height: 12%; } .row-desc { height: 10%; align-items: center; }
        .row-metrics { height: 22%; } .row-details { height: 23%; } .row-footer { height: 15%; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        @media print {
            @page { size: 6in 4in; margin: 0mm; }
            html, body { height: auto !important; overflow: visible !important; background: white !important; margin: 0 !important; padding: 0 !important; }
            .no-print { display: none !important; }
            .print-container { display: block !important; width: 100% !important; height: auto !important; margin: 0 !important; padding: 0 !important; position: static !important; }
            /* Asegura que el contenedor de la etiqueta ocupe 6x4in sin padding ni margen */
            .label-wrapper { display: block !important; width: 6in !important; height: 4in !important; margin: 0 !important; padding: 0 !important; border: none !important; box-shadow: none !important; border-radius: 0 !important; break-after: page; page-break-after: always; page-break-inside: avoid; }
            .label-preview-container { border: 2px solid #000 !important; width: 6in !important; height: 4in !important; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo, useCallback } = React;

        const firebaseConfig = {
            apiKey: "AIzaSyBqHgV4vDat1-VmZfKbiPg7nuiX-ROcexw",
            authDomain: "cirineo-cec21.firebaseapp.com",
            projectId: "cirineo-cec21",
            storageBucket: "cirineo-cec21.firebasestorage.app",
            messagingSenderId: "620210618284",
            appId: "1:620210618284:web:482bab9bf74650fff18409",
            measurementId: "G-B7YLM78RVW"
        };
        
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const FieldValue = firebase.firestore.FieldValue; 

        const Icon = ({ name, size = 18, className }) => {
            const containerRef = useRef(null);
            useEffect(() => {
                if (containerRef.current && lucide.icons[name]) {
                    containerRef.current.innerHTML = lucide.icons[name].toSvg({ width: size, height: size, class: className });
                }
            }, [name, size, className]);
            return <div ref={containerRef} className="inline-block" style={{ width: size, height: size }}></div>;
        };

        const ProductionLabel = ({ labelData }) => {
            const svgRef = useRef(null);
            const order = labelData; 
            const subPiece = order.subPiecesData ? order.subPiecesData.find(sp => sp.pieza === order.piezaNombre) : (order.subPiecesData?.[0] || {});
            
            const materialNylon = order.threading ? order.threading.find(t => t.material && t.material.toUpperCase().includes('NYLON')) : null;
            const materialLycra = order.threading ? order.threading.find(t => t.material && t.material.toUpperCase().includes('LYCRA')) : null;
            const lycraText = materialLycra ? materialLycra.material.replace(/LYCRA/i, '').trim() : (order.threading && order.threading[1] ? order.threading[1].material : 'N/A');
            const nylonText = materialNylon ? materialNylon.material.replace(/NYLON/i, '').trim() : (order.threading && order.threading[0] ? order.threading[0].material : 'N/A');
            
            const barcodeValue = order.packageCode; 
            const fechaEntrega = order.fechaEntrega || new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toLocaleDateString('es-MX');

            useEffect(() => {
                if (svgRef.current && barcodeValue) {
                    try {
                        JsBarcode(svgRef.current, barcodeValue, { format: "CODE128", lineColor: "#000", width: 1.5, height: 40, displayValue: false, margin: 0 });
                        svgRef.current.style.width = '2.5in'; svgRef.current.style.height = 'auto'; 
                    } catch (e) { console.error("Error barcode", e); }
                }
            }, [barcodeValue]);

            return (
                <div className="label-preview-container">
                    <div className="lbl-row row-header">
                        <div className="lbl-col" style={{width: '60%'}}>
                            <div className="lbl-title">MODELO</div><div className="lbl-big">{order.codigo || 'S/N'}</div>
                        </div>
                        <div className="lbl-col" style={{width: '40%'}}>
                            <div className="lbl-title">TOTAL PIEZAS ORDEN</div><div className="lbl-big">{order.totalPedido || 0}</div>
                        </div>
                    </div>
                    <div className="lbl-row row-info">
                        <div className="lbl-col" style={{width: '50%'}}>
                            <div className="lbl-title">PARTIDA</div><div className="lbl-medium">{order.partida || '---'}</div>
                        </div>
                        <div className="lbl-col" style={{width: '50%'}}>
                            <div className="lbl-title">CLIENTE</div><div className="lbl-medium" style={{fontSize: order.cliente?.length > 10 ? '22px' : '26px'}}>{order.cliente || '---'}</div>
                        </div>
                    </div>
                    <div className="lbl-row row-desc">
                        <div className="lbl-col" style={{flexDirection: 'row', alignItems: 'baseline', gap: '10px', width: '100%'}}>
                            <span className="lbl-title">DESCRIPCION:</span><span style={{fontSize: '16px', fontWeight: 'bold'}}>{order.piezaNombre || subPiece?.pieza || 'ESTANDAR'}</span>
                        </div>
                    </div>
                    <div className="lbl-row row-metrics">
                        <div className="lbl-col" style={{width: '33.33%', textAlign: 'center'}}>
                            <div className="lbl-title" style={{fontSize: '11px'}}>PAQUETE<br/>ACTUAL</div><div className="lbl-big" style={{fontSize: '48px'}}>{order.displayPackageId}</div>
                        </div>
                        <div className="lbl-col" style={{width: '33.33%', backgroundColor: '#e0e0e0', textAlign: 'center'}}>
                            <div className="lbl-title" style={{fontSize: '11px'}}>PIEZAS EN<br/>PAQUETE</div><div className="lbl-big" style={{fontSize: '48px'}}>{order.piecesInPackage}</div>
                        </div>
                        <div className="lbl-col" style={{width: '33.33%', textAlign: 'center'}}>
                            <div className="lbl-title">MAQUINA</div><div className="lbl-big" style={{fontSize: '48px'}}>{order.maquina || '0'}</div>
                        </div>
                    </div>
                    <div className="lbl-row row-details">
                        <div style={{width: '50%', display: 'flex', flexDirection: 'column', borderRight: '2px solid black'}}>
                            <div style={{flex: 1, display: 'flex', alignItems: 'center', borderBottom: '1px solid black', padding: '0 5px'}}>
                                <span className="lbl-title" style={{width: '50px'}}>NYLON</span><span className="lbl-small truncate" style={{fontSize: '14px'}} title={nylonText}>{nylonText.substring(0, 18)}</span>
                            </div>
                            <div style={{flex: 1, display: 'flex', alignItems: 'center', padding: '0 5px'}}>
                                <span className="lbl-title" style={{width: '50px'}}>LYCRA</span><span className="lbl-small truncate" style={{fontSize: '14px'}} title={lycraText}>{lycraText.substring(0, 18)}</span>
                            </div>
                        </div>
                        <div style={{width: '50%', display: 'grid', gridTemplateColumns: '1fr 1fr', gridTemplateRows: '1fr 1fr'}}>
                            <div className="lbl-col" style={{borderBottom: '1px solid black', borderRight: '1px solid black', padding: '2px'}}>
                                <div className="lbl-title">TALLA</div><div className="lbl-medium" style={{fontSize: '20px'}}>{subPiece?.talla || 'UNI'}</div>
                            </div>
                            <div className="lbl-col" style={{borderBottom: '1px solid black', padding: '2px'}}>
                                <div className="lbl-title">PESO (g)</div><div className="lbl-small">{subPiece?.peso || '---'}</div>
                            </div>
                            <div className="lbl-col" style={{gridColumn: 'span 2', padding: '2px', flexDirection: 'row', justifyContent: 'space-between', alignItems: 'center'}}>
                                <div className="lbl-title">TIEMPO (min)</div><div className="lbl-small" style={{fontSize: '20px', marginRight: '10px'}}>{subPiece?.tiempo || '---'}</div>
                            </div>
                        </div>
                    </div>
                    <div className="lbl-row row-footer" style={{padding: '0 10px', alignItems: 'center', justifyContent: 'space-between'}}>
                        <div style={{display: 'flex', flexDirection: 'column'}}>
                            <div className="lbl-title">FECHA DE ENTREGA</div><div className="lbl-medium" style={{fontSize: '20px'}}>{fechaEntrega}</div>
                        </div>
                        <div style={{display: 'flex', flexDirection: 'column', alignItems: 'flex-end', flexGrow: 1}}>
                            <svg ref={svgRef} style={{maxWidth: '2.5in', width: '2.5in', height: 'auto'}}></svg>
                            {/* FIX: Se eliminó la clase 'mt-1' del div de abajo para evitar el desborde que generaba la página extra en el PDF. */}
                            <div className="text-[10px] font-mono text-center w-full bg-white px-1 relative z-10">{barcodeValue}</div>
                        </div>
                    </div>
                </div>
            );
        };

        const QuickScannerModal = ({ isVisible, onClose, allOrders, onScanSaved }) => {
            const [scans, setScans] = useState([]);
            const [scanStatus, setScanStatus] = useState({ message: 'Cargando cámara...', type: 'info' });
            const [isSaving, setIsSaving] = useState(false);
            const scannerRef = useRef(null);

            useEffect(() => {
                if (isVisible) {
                    setScans([]);
                    setScanStatus({ message: 'Escanee los códigos únicos de los paquetes...', type: 'info' });
                    
                    setTimeout(() => {
                        const html5QrcodeScanner = new Html5QrcodeScanner(
                            "reader", 
                            { fps: 10, qrbox: { width: 250, height: 150 }, aspectRatio: 1.0, videoConstraints: { facingMode: "environment" } },
                            false
                        );

                        const onScanSuccess = (decodedText) => {
                            handleQuickScan(decodedText);
                            html5QrcodeScanner.pause(); 
                            setTimeout(() => html5QrcodeScanner.resume(), 1500); 
                        };

                        html5QrcodeScanner.render(onScanSuccess, (errorMessage) => {});
                        scannerRef.current = html5QrcodeScanner;
                    }, 100);
                } else {
                    if (scannerRef.current) {
                        scannerRef.current.clear().catch(err => console.error(err));
                        scannerRef.current = null;
                    }
                }
                return () => { if (scannerRef.current) scannerRef.current.clear().catch(err => {}); };
            }, [isVisible]);

            const handleQuickScan = (rawCode) => {
                if (!rawCode) return;
                const scannedCode = rawCode.trim();

                if (scans.includes(scannedCode)) {
                    setScanStatus({ message: `Código ${scannedCode} ya escaneado.`, type: 'warning' });
                    return;
                }

                let foundPackage = null;
                let foundOrder = null;

                for (const order of allOrders) {
                    if (order.progreso) {
                        const pkg = order.progreso.find(p => p.codigoUnico === scannedCode);
                        if (pkg) {
                            foundPackage = pkg;
                            foundOrder = order;
                            break;
                        }
                    }
                }

                if (!foundPackage || !foundOrder) {
                    setScanStatus({ message: `Código ${scannedCode} NO encontrado en ninguna orden activa.`, type: 'error' });
                    return;
                }

                setScans(prev => [...prev, scannedCode]);
                setScanStatus({ message: `¡Encontrado! ${foundPackage.piezaNombre} (${foundPackage.paqueteNum}/${foundPackage.paquetesDePieza})`, type: 'success' });
            };

            const handleRemoveScan = (codeToRemove) => setScans(prev => prev.filter(code => code !== codeToRemove));

            const handleSaveAll = async () => {
                if (scans.length === 0 || isSaving) return;
                setIsSaving(true);
                setScanStatus({ message: `Guardando registros...`, type: 'info' });

                const successfulScans = [];
                const failedScans = [];
                const tejedoraName = "Balta"; 

                for (const scannedCode of scans) {
                    try {
                        let foundPackage = null;
                        let foundOrder = null;
                        for (const order of allOrders) {
                            if (order.progreso) {
                                const pkg = order.progreso.find(p => p.codigoUnico === scannedCode);
                                if (pkg) { foundPackage = pkg; foundOrder = order; break; }
                            }
                        }

                        if (!foundPackage) { failedScans.push(scannedCode); continue; }

                        const globalScanCheck = await db.collection('registro_produccion').where('codigo_paquete', '==', scannedCode).get();
                        if (!globalScanCheck.empty) {
                            failedScans.push(`${scannedCode} (Duplicado)`);
                            continue;
                        }

                        await db.collection('registro_produccion').doc().set({
                            codigo_paquete: scannedCode, 
                            orderId: String(foundOrder.id), 
                            fecha: FieldValue.serverTimestamp(),
                            fecha_legible: new Date().toLocaleDateString('es-MX', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' }).replace(/\//g, '/'), 
                            tejedor: tejedoraName,
                            tipo: "produccion",
                            modelo: foundOrder.codigo,
                            partida: foundOrder.partida,
                            paquete_indice: foundPackage.paqueteNum, 
                            paquete_total: foundPackage.paquetesDePieza,
                            piezas_en_paquete: foundPackage.cantidad
                        });
                        
                        successfulScans.push(scannedCode);

                    } catch (error) {
                        console.error("Error saving:", error);
                        failedScans.push(`${scannedCode} (Error)`);
                    }
                }

                setIsSaving(false);
                if (successfulScans.length > 0) {
                    onScanSaved(); 
                    onClose(); 
                    alert(`Guardados: ${successfulScans.length}. Fallidos: ${failedScans.length}`);
                } else {
                    setScanStatus({ message: `Error al guardar.`, type: 'error' });
                }
            };

            if (!isVisible) return null;

            return (
                <div className="fixed inset-0 bg-black/80 z-[100] flex flex-col items-center justify-center p-4">
                    <div className="w-full max-w-2xl bg-white rounded-xl shadow-2xl overflow-hidden flex flex-col max-h-[95vh]">
                        <div className="flex justify-between items-center p-4 bg-slate-800 text-white">
                            <h2 className="font-bold text-xl flex items-center gap-2"><Icon name="scan"/> ESCANEO DE PAQUETES</h2>
                            <button onClick={onClose} className="bg-red-600 hover:bg-red-700 text-white px-3 py-1.5 rounded text-sm font-bold">CERRAR</button>
                        </div>
                        <div className="flex flex-col md:flex-row flex-grow min-h-0">
                            <div className="w-full md:w-1/2 bg-black flex flex-col justify-center items-center p-2 relative">
                                <div id="reader" className="w-full aspect-video md:aspect-square bg-black"></div>
                                <div className={`mt-2 p-2 rounded text-xs text-center font-medium w-full bg-slate-100`}>{scanStatus.message}</div>
                            </div>
                            <div className="w-full md:w-1/2 flex flex-col p-4">
                                <h3 className="font-bold text-slate-700 mb-3">Códigos Leídos ({scans.length})</h3>
                                <div className="flex-grow overflow-y-auto border border-slate-300 rounded p-2 mb-4 bg-slate-50">
                                    <ul className="space-y-1">
                                        {scans.map(code => (
                                            <li key={code} className="flex justify-between items-center p-2 bg-white rounded shadow-sm border border-slate-200">
                                                <span className="font-mono text-sm font-bold text-slate-800">{code}</span>
                                                <button onClick={() => handleRemoveScan(code)} className="text-red-500"><Icon name="x" size={14}/></button>
                                            </li>
                                        ))}
                                    </ul>
                                </div>
                                <button onClick={handleSaveAll} disabled={scans.length === 0 || isSaving} className={`w-full py-3 rounded-lg font-bold text-white ${scans.length === 0 || isSaving ? 'bg-slate-400' : 'bg-green-600'}`}>
                                    {isSaving ? 'Guardando...' : 'GUARDAR TODO'}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const ScanTracker = ({ selectedOrder, packageLabels, onOpenQuickScan }) => {
            const [scannedData, setScannedData] = useState([]);
            const orderId = selectedOrder?.id;
            useEffect(() => {
                if (!orderId) { setScannedData([]); return; }
                const unsubscribe = db.collection('registro_produccion').where('orderId', '==', String(orderId)).onSnapshot(snapshot => {
                    setScannedData(snapshot.docs.map(doc => doc.data()));
                });
                return () => unsubscribe();
            }, [orderId]);
            
            const { scannedPackages, pendingPackages } = useMemo(() => {
                if (!orderId) return { scannedPackages: [], pendingPackages: [] };
                const scannedCodes = new Set(scannedData.map(d => d.codigo_paquete));
                const packages = packageLabels.map(label => ({
                    ...label,
                    isScanned: scannedCodes.has(label.packageCode),
                }));
                return {
                    scannedPackages: packages.filter(p => p.isScanned),
                    pendingPackages: packages.filter(p => !p.isScanned)
                };
            }, [packageLabels, scannedData, orderId]);

            return (
                <div className="w-full lg:w-96 bg-white border-l border-slate-200 flex flex-col no-print relative shrink-0">
                    <div className="p-4 border-b bg-slate-50">
                        <h3 className="font-bold text-lg flex items-center gap-2 text-slate-800 mb-3"><Icon name="scan"/> Control</h3>
                        <button onClick={onOpenQuickScan} className="w-full py-2 bg-blue-600 text-white rounded font-bold hover:bg-blue-700 transition shadow-md flex items-center justify-center gap-2 text-sm"><Icon name="camera" size={18} /> ESCANEAR</button>
                    </div>
                    {selectedOrder && (
                        <div className="flex-grow overflow-y-auto p-3 space-y-4">
                            <div className="bg-red-50 p-3 rounded"><h4 className="font-bold text-red-800 text-xs mb-2">PENDIENTES</h4><div className="grid grid-cols-4 gap-2">{pendingPackages.map(p => <div key={p.packageCode} className="p-1 text-center bg-white border border-red-300 rounded text-xs font-bold">{p.packageIndex}</div>)}</div></div>
                            <div className="bg-green-50 p-3 rounded"><h4 className="font-bold text-green-800 text-xs mb-2">LISTOS</h4><div className="grid grid-cols-4 gap-2">{scannedPackages.map(p => <div key={p.packageCode} className="p-1 text-center bg-white border border-green-300 rounded text-xs font-bold text-green-800">{p.packageIndex}</div>)}</div></div>
                        </div>
                    )}
                </div>
            );
        };

        const App = () => {
            const [orders, setOrders] = useState([]);
            const [selectedOrder, setSelectedOrder] = useState(null); 
            const [packageLabels, setPackageLabels] = useState([]); 
            const [filterText, setFilterText] = useState('');
            const [showScanner, setShowScanner] = useState(false);
            const [isGeneratingPdf, setIsGeneratingPdf] = useState(false); // Estado de carga para el PDF

            const generatePackageLabels = (order) => {
                if (order.progreso && order.progreso.length > 0) {
                    return order.progreso.map(p => ({
                        ...order,
                        piezaNombre: p.piezaNombre, 
                        packageIndex: p.paqueteNum,
                        totalPackages: p.paquetesDePieza,
                        piecesInPackage: p.cantidad,
                        packageCode: p.codigoUnico, 
                        displayPackageId: `${p.paqueteNum}/${p.paquetesDePieza}`
                    }));
                }
                return [];
            };

            useEffect(() => {
                const unsubscribe = db.collection('orders').where('status', '!=', 'ARCHIVADO').onSnapshot(snapshot => {
                        const fetchedOrders = snapshot.docs.map(doc => doc.data());
                        fetchedOrders.sort((a, b) => b.id - a.id);
                        setOrders(fetchedOrders);
                    });
                return () => unsubscribe();
            }, []);
            
            useEffect(() => {
                if (selectedOrder) { setPackageLabels(generatePackageLabels(selectedOrder)); } else { setPackageLabels([]); }
            }, [selectedOrder]);

            const filteredOrders = useMemo(() => {
                if (!filterText) return orders;
                const txt = filterText.toUpperCase();
                return orders.filter(o => (o.codigo && o.codigo.includes(txt)) || (o.cliente && o.cliente.includes(txt)));
            }, [orders, filterText]);

            const handlePrint = () => { if(packageLabels.length > 0) window.print(); };

            // === FUNCIÓN PARA DESCARGAR PDF (FIXEADA) ===
            const handleDownloadPDF = () => {
                if (packageLabels.length === 0) return;
                setIsGeneratingPdf(true);
                
                // 1. Seleccionamos el contenedor que tiene todas las etiquetas
                const element = document.querySelector('.print-container');
                
                // 2. Opciones especificas para 6x4 pulgadas
                const opt = {
                    margin:       0,
                    filename:     `${selectedOrder.codigo || 'orden'}_${packageLabels.length}pqts.pdf`,
                    image:        { type: 'jpeg', quality: 0.98 },
                    html2canvas:  { scale: 2, useCORS: true, logging: false, backgroundColor: '#ffffff' }, 
                    jsPDF:        { unit: 'in', format: [6, 4], orientation: 'landscape' } // Dimensiones exactas
                };

                // 3. Añadir clase temporal para que html2pdf ignore los margenes/sombras de la vista de pantalla
                element.classList.add('pdf-mode');

                html2pdf().set(opt).from(element).save().then(() => {
                    // 4. Limpieza
                    element.classList.remove('pdf-mode');
                    setIsGeneratingPdf(false);
                }).catch(err => {
                    console.error("Error al generar PDF:", err);
                    element.classList.remove('pdf-mode');
                    setIsGeneratingPdf(false);
                    alert("Error al generar PDF. Revise la consola.");
                });
            };

            return (
                <div className="flex flex-col lg:flex-row h-screen w-full">
                    <div className="w-full lg:w-80 bg-slate-800 text-white flex flex-col border-r border-slate-700 shadow-xl no-print z-10 shrink-0 h-64 lg:h-auto">
                        <div className="p-4 bg-slate-900 border-b border-slate-700">
                            <h1 className="text-xl font-bold text-yellow-400">PAPELETAS</h1>
                            <input type="text" placeholder="Buscar..." value={filterText} onChange={e => setFilterText(e.target.value)} className="w-full mt-2 bg-slate-800 border border-slate-600 rounded p-2 text-sm" />
                        </div>
                        <div className="flex-grow overflow-y-auto p-2 space-y-2">
                            {filteredOrders.map(order => (
                                <div key={order.id} onClick={() => setSelectedOrder(order)} className={`p-3 rounded cursor-pointer border-l-4 transition-all ${selectedOrder?.id === order.id ? 'bg-slate-700 border-yellow-400' : 'bg-slate-800/50 border-transparent'}`}>
                                    <div className="font-bold">{order.codigo}</div>
                                    <div className="text-xs text-slate-400">{order.cliente}</div>
                                </div>
                            ))}
                        </div>
                    </div>

                    <div className="flex-grow bg-slate-100 flex flex-col relative overflow-auto h-96 lg:h-auto">
                        <div className="bg-white p-4 shadow-sm border-b flex justify-between items-center no-print sticky top-0 z-10">
                            <h2 className="font-bold text-slate-700">{selectedOrder ? `${selectedOrder.codigo} (${packageLabels.length} PAQUETES)` : 'Seleccione orden'}</h2>
                            {selectedOrder && (
                                <div className="flex gap-2">
                                    <button onClick={handleDownloadPDF} disabled={isGeneratingPdf} className={`px-3 py-2 text-white rounded font-bold text-sm flex gap-2 ${isGeneratingPdf ? 'bg-slate-400 cursor-wait' : 'bg-red-600 hover:bg-red-700 shadow-md'}`}>
                                        <Icon name="download" size={16}/> {isGeneratingPdf ? 'GENERANDO...' : 'DESCARGAR PDF'}
                                    </button>
                                    <button onClick={handlePrint} className="px-3 py-2 bg-slate-900 text-white rounded font-bold text-sm flex gap-2 hover:bg-slate-800 shadow-md">
                                        <Icon name="printer" size={16}/> IMPRIMIR
                                    </button>
                                </div>
                            )}
                        </div>
                        <div className="flex-grow flex flex-col items-center p-4 lg:p-10 bg-slate-200 overflow-y-auto print-container">
                            {packageLabels.length > 0 ? ( packageLabels.map((labelData, index) => ( <div key={index} className="label-wrapper"><ProductionLabel labelData={labelData} /></div> )) ) : ( <div className="text-center text-slate-400 mt-20">Selecciona una orden</div> )}
                        </div>
                    </div>

                    <ScanTracker selectedOrder={selectedOrder} packageLabels={packageLabels} onOpenQuickScan={() => setShowScanner(true)} />
                    <QuickScannerModal isVisible={showScanner} onClose={() => setShowScanner(false)} allOrders={orders} onScanSaved={() => {}} />
                </div>
            );
        };
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
